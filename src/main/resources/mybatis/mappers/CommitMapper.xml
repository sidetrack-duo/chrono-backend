<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.chrono.mapper.CommitMapper">

    <select id="findLatestCommitDate" resultType="java.time.LocalDateTime">
        SELECT commit_date
        FROM commit_entity
        WHERE project_id = #{projectId}
        ORDER BY commit_date DESC
        LIMIT 1
    </select>

    <!--    전체 커밋수 -->
    <select id="countTotalCommits" resultType="int">
        SELECT count(*)
        FROM commit_entity
        WHERE project_id = #{projectId}
    </select>

<!--    이번 주 커밋 수-->
    <select id="countCommitsThisWeek" resultType="int">
        SELECT COUNT(*)
        FROM commit_entity
        WHERE project_id = #{projectId}
        and YEARWEEK(commit_date, 1) = YEARWEEK(NOW(), 1)
    </select>

<!--    가장 활발한 날-->
    <select id="findMostActiveDay" resultType="string">
        SELECT DAYNAME(commit_date)
        FROM commit_entity
        WHERE project_id = #{projectId}
        GROUP BY DAYNAME(commit_date)
        ORDER BY COUNT(*) DESC
        LIMIT 1
    </select>

<!--    위클리 커밋-->
    <select id="findCommitDatesForAnalysis" resultType="string">
        SELECT
        DATE_FORMAT(commit_date, '%Y-%m-%dT%H:%i:%s')
        FROM commit_entity
        WHERE project_id = #{projectId}
    </select>

<!--    커밋 전체 조회-->
    <select id="findAllCommitsByProject" resultType="com.chrono.dto.CommitResponseDto">
        select
            sha           AS sha,
            message       AS message,
            author_name   AS authorName,
            author_email  AS authorEmail,
            commit_date   AS commitDate
        from commit_entity
        where project_id = #{projectId}
        order by commit_date desc
    </select>

<!--    파이썬 전달, 커밋 목록 조회하기-->
    <select id="findCommitsForAnalysis"
            resultType="com.chrono.dto.CommitAnalyzeRequestDto$CommitItemDto">
        SELECT
        sha,
        DATE_FORMAT(commit_date, '%Y-%m-%dT%H:%i:%s') AS date,
        message
        FROM commit_entity
        WHERE project_id = #{projectId}
    </select>

<!--    최근 14일 일별 커밋 집계-->
    <select id="selectDailyCommitHistory" resultType="com.chrono.dto.CommitHistoryCountDto">
        SELECT
            DATE(c.commit_date) AS date, COUNT(*) AS count
        FROM commit_entity c
            JOIN projects p ON c.project_id = p.project_id
        WHERE p.project_id = #{projectId}
            AND p.active = true
            AND c.commit_date >= DATE_SUB(CURDATE(), INTERVAL 13 DAY)
        GROUP BY DATE(c.commit_date)
        ORDER BY date
    </select>


</mapper>
